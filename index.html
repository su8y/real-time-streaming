<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Real-Time Streaming Test</title>
    <link rel="stylesheet" href="./node_modules/bootstrap/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="./node_modules/github-markdown-css/github-markdown-light.css" />

</head>
<body class="bg-light">
<div class="container text-center p-4 h-100">
    <div class="row">
        <div class="col-3">
            <select id="fetchURL" class="form-select">
                <option selected value="http://127.0.0.1:8000/stream/output">fastAPI</option>
                <option value="http://localhost:8080/stream/rest/output">Spring(RestAPI, StreamingResponseBody.class)</option>

            </select>
        </div>
        <div class="col-8">
            <h4 id="generate-button" onclick="fetchStream()" class="btn btn-outline-info w-100 fw-semibold">
                Test Real Time Steaming
            </h4>
        </div>
    </div>
    <div id="generate-field" class="markdown-body row border border-1 rounded-2 text-black-50 h-50 p-2">
        Generate Answer ...
    </div>

</div>
<script>
    async function fetchStream(){
        try{
            const fetchURLEl = document.querySelector("#fetchURL");
            const response = await fetch(fetchURLEl.value);
            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");

            const output = document.querySelector("#generate-field");
            output.innerHTML = '';

            while(true){
                const {done, value} = await reader.read();
                console.log({done, value});
                if(done) break;
                const chunk = decoder.decode(value, {stream: true});
                const messages = chunk.trim().split('\n\n');
                messages.forEach((message)=>{
                    if(message.startsWith('data: ')){
                        const token = message.replace('data: ','');
                        output.innerHTML += token;
                    }
                })
            }

            const button = document.querySelector("#generate-button");
            button.textContent = 'Test Real Time Streaming';
            button.classList.add('btn-outline-info');
            button.classList.remove('btn-outline-danger');
        }catch (e){
            const button = document.querySelector("#generate-button");
            button.textContent = 'Test Real Time Streaming ( Not Found API )';
            button.classList.add('btn-outline-danger');
            button.classList.remove('btn-outline-info');
        }
    }
</script>


<script type="text/javascript" src="./node_modules/@popperjs/core/dist/umd/popper.min.js"></script>
<script type="text/javascript" src="./node_modules/bootstrap/dist/js/bootstrap.bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</body>
</html>